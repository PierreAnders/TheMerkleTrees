@using Microsoft.Extensions.Configuration
@using MongoDB.Bson
@using System.Diagnostics
@using System.Net.Http
@using System.Net.Http.Json
@using System.ComponentModel
@using System.Globalization
@using System.Net
@using System.Security.Claims
@using MetaMask.Blazor
@using Microsoft.AspNetCore.Components.Authorization
@using Newtonsoft.Json.Bson
@using TheMerkleTrees.Client.Models
@inject AuthenticationStateProvider AuthStateProvider
@inject IMetaMaskService MetaMaskService
@inject HttpClient Http
@inject IConfiguration Configuration
@inject FileStateContainer FileState

<div class="min-h-[85vh] w-full flex items-center justify-center flex-col bg-white">

    <img class="mb-16" src="images/the-merkle-trees-logo.svg" width="300px" height="300px" alt="File Logo"/>

    <img class="mt-12" src="images/upload-logo.svg" width="58px" height="58px" alt="File Logo"/>
    <InputFile class="text-gray-500 transition ease-in-out duration-600 text-sm hover:text-white border border-gray-700 hover:bg-gray-800 px-2 py-1 rounded mt-4 mb-2 cursor-pointer"
               OnChange="@HandleFileSelected" />

    <div class="text-gray-500 mt-4 mb-1">
        <label class="text-sm" for="category">Categorie:</label>
        <InputSelect @bind-Value="category" TValue="string" class="text-sm px-4 py-1 hover:text-white border border-gray-700 hover:bg-gray-800 rounded">
            <option value="">Choisir</option>
            @foreach (var cat in categories)
            {
                <option value="@cat.Name">@cat.Name</option>
            }
        </InputSelect>
    </div>

    <div class="text-gray-500 mt-4 mb-1">
        <input type="checkbox" id="isPublic" @bind="isPublic" />
        <label class="text-sm" for="isPublic">Public</label>
    </div>

    @if (fileContent != null)
    {
        <button class="transition ease-in-out duration-300 text-sm text-white bg-gray-700 hover:bg-gray-800 px-4 py-2 mt-4 rounded"
                @onclick="AddToIPFS">
            Valider
        </button>
    }
</div>

@code {
    private byte[] fileContent;
    private string fileName;
    private string category;
    private bool isPublic;
    private string userAddress;
    private string apiBaseUrl;
    private List<Category> categories;

    protected override async Task OnInitializedAsync()
    {
        apiBaseUrl = Configuration["ApiBaseUrl"];
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            userAddress = user.Identity.Name;
        }
        else
        {
            Console.WriteLine("User is not authenticated");
        }
        
        categories = await Http.GetFromJsonAsync<List<Category>>($"{apiBaseUrl}/api/Categories/user/{userAddress}");
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        fileName = file.Name;
        using var ms = new MemoryStream();
        await file.OpenReadStream(1024 * 1024 * 5).CopyToAsync(ms);
        fileContent = ms.ToArray();
    }

    private async Task AddToIPFS()
    {

        if (fileContent == null || string.IsNullOrEmpty(fileName) || string.IsNullOrEmpty(category) || string.IsNullOrEmpty(userAddress))
        {
            Console.WriteLine("One or more required fields are null or empty.");
            return;
        }

        var formData = new MultipartFormDataContent();
        formData.Add(new ByteArrayContent(fileContent), "file", fileName);
        formData.Add(new StringContent(category), "category");
        formData.Add(new StringContent(isPublic.ToString()), "isPublic");
        formData.Add(new StringContent(userAddress), "userAddress");

        var response = await Http.PostAsync($"{apiBaseUrl}/api/Files/Upload", formData);
        response.EnsureSuccessStatusCode();

        var result = await response.Content.ReadFromJsonAsync<UploadResponse>();
        Console.WriteLine($"Fichier ajouté à IPFS avec URL : {result.Url}");
        
        await ReloadData();
    }

    private async Task ReloadData()
    {
        var files = await Http.GetFromJsonAsync<List<File>>($"{apiBaseUrl}/api/Files/user/{userAddress}");
        FileState.SetFiles(files);
    }
    
    private class UploadResponse
    {
        public string Url { get; set; }
    }
    
    public class Category
    {
        public string Id { get; set; }
        public string Name { get; set; }
        public string Owner { get; set; }
    }
}